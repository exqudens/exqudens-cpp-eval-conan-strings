#!/bin/bash

SCRIPT_CMAKE_PROGRAM="${CMAKE_PROGRAM}"
SCRIPT_CONAN_PROGRAM="${CONAN_PROGRAM}"

SCRIPT_ROOT_PROJECT_PATH="$(cd "$(dirname "${0}")" &> /dev/null && pwd)"
SCRIPT_ROOT_PROJECT_NAME="$(basename "${SCRIPT_ROOT_PROJECT_PATH}")"
SCRIPT_LIBRARY_PROJECT_NAME="library-${SCRIPT_ROOT_PROJECT_NAME}"
SCRIPT_TEST_PROJECT_NAME="test-${SCRIPT_ROOT_PROJECT_NAME}"

SCRIPT_BUILD_SHARED_LIBS='true'
if [ "static" == "${1}" ]
then
  SCRIPT_BUILD_SHARED_LIBS='false'
fi

SCRIPT_MSVC_RUNTIME_LIBRARY='MultiThreadedDLL'
SCRIPT_BUILD_TYPE='Release'
SCRIPT_GENERATOR='Visual Studio 16 2019'

"${SCRIPT_CMAKE_PROGRAM}" -DBUILD_SHARED_LIBS:BOOL="${SCRIPT_BUILD_SHARED_LIBS}" -DCMAKE_MSVC_RUNTIME_LIBRARY:STRING="${SCRIPT_MSVC_RUNTIME_LIBRARY}" -DCMAKE_BUILD_TYPE:STRING="${SCRIPT_BUILD_TYPE}" -DCMAKE_CONAN_PROGRAM:FILEPATH="${SCRIPT_CONAN_PROGRAM}" -G "${SCRIPT_GENERATOR}" -S "${SCRIPT_ROOT_PROJECT_PATH}" -B "${SCRIPT_ROOT_PROJECT_PATH}/build" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_LIBRARY_PROJECT_NAME}-conan-install" &&\
"${SCRIPT_CMAKE_PROGRAM}" "build" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_LIBRARY_PROJECT_NAME}" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "install" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_LIBRARY_PROJECT_NAME}-conan-export-testing" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_TEST_PROJECT_NAME}-conan-install" &&\
"${SCRIPT_CMAKE_PROGRAM}" "build" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_TEST_PROJECT_NAME}-executable" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_TEST_PROJECT_NAME}" &&\
"${SCRIPT_CMAKE_PROGRAM}" --build "build" --target "${SCRIPT_LIBRARY_PROJECT_NAME}-conan-export" &&\
echo 'BUILD_SUCCESSFUL' ||\
(echo 'BUILD_FAILED' && false)
